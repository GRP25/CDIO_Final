async function openProductBatch() {
	var productBatchID = $("#ProductBatchToWeight").val();
	await getProductBatch(productBatchID, false);

	var productBatchStatus = $("#showInputStatus").text();


	// show productBatch information
	$("#WeightSumTara").html("");
	$("#WeightSumNetto").html("");
	$("#WeightProductBatchStatus").html(productBatchStatus);
	$("#WeightProductBatchStartDate").html($("#showStartDate").html());
	$("#WeightProductBatchEndDate").html($("#showEndDate").html());

	var presID = $("#showPrescriptionID").html();
	weightPriscriptiuonID = presID;
	await getPrescription(presID);
	$("#WeightPrescriptionID").html(presID);
	let number = await getPrescriptionCompList(presID, productBatchID);
	sumTotal(number);
	//document.getElementById("WeightPrescriptionName").innerHTML = ;
}





async function getPrescriptionCompList(prescriptionID, productBatchID) {
	$("#loaderID").show();
	var number = 0;

	await $.ajax({
		url: "https://api.mama.sh/PrescriptionComp/" + prescriptionID,
		contentType: "application/json",
		type: "GET",
		success: function (response) {
			$("#loaderID").hide();
			$("#WeightCommodityBatchList").html("");

			for (const prescriptionComp of response) {
				number++;
				ShowPrescriptionCompToLab(prescriptionComp, number, productBatchID);

			}
		},
		error: function (jqXHR, text, error) {
			$("#loaderID").hide();
			console.log(jqXHR.status + text + error);
		}
	});
	return number;
}

function sumTotal(number) {
	console.log("Hello world");
	var weightNettoTotal = 0;
	var weightTaraTotal = 0;

	for (let index = 1; index <= number; index++) {

		console.log(index + "Dtara: " + Number($('#WeightLineTara' + index).html()));
		console.log(index + "tara: " + $('#WeightLineTara' + index).html());
		console.log(index + "DNetto: " + Number($('#WeightLineNetto' + index).html()));
		console.log(index + "Netto: " + $('#WeightLineNetto' + index).html());

		weightTaraTotal += Number($('#WeightLineTara' + index).html());

		weightNettoTotal += Number($('#WeightLineNetto' + index).html());
	}
	console.log('Tara Total: ' + weightTaraTotal + ', Netto Total: ' + weightNettoTotal);

	// print to screen
	$('#WeightSumTara').text(weightTaraTotal);
	$('#WeightSumNetto').text(weightNettoTotal);
}

async function CreateProductBatchComp(commodityID, number) {
	$("#loaderID").show();
	// work in progress
	var productBatchID = $('#ProductBatchToWeight').val();

	var productbatchcomp = {
		productBatch_id: productBatchID,
		commodityBatch_id: commodityID, //$('#WeightCommodityID').val(),
		user_id: userobject.userID, // add current user
		tara: $("#WeightTara" + commodityID).val(),
		netto: $("#WeightNetto" + commodityID).val(),
	};

	// setup for weight tolerance
	var weightLineNonNetto = $('#WeightLineNonNetto' + number).html();
	var WeightLineTolerance = $('#WeightLineTolerance' + number).html();
	console.log(weightLineNonNetto + ', ' + WeightLineTolerance);

	// get the tollance weight
	let minWeightTolerance = weightLineNonNetto * (1 - (WeightLineTolerance / 100));
	let maxWeightTolerance = weightLineNonNetto * (1 + (WeightLineTolerance / 100));

	// test for variable
	console.log(minWeightTolerance + ' , ' + maxWeightTolerance);

	// test if weight is acceptable
	if (minWeightTolerance < productbatchcomp.netto && maxWeightTolerance > productbatchcomp.netto) {
		console.log("Netto weight: good to go");

		await $.ajax({
			url: "https://api.mama.sh/productbatchcomp",
			contentType: "application/json",
			type: "POST",
			data: JSON.stringify(productbatchcomp),
			success: function (response) {
				$("#loaderID").hide();
				alert("ProductBatch Comp has been added");
			},
			error: function (jqXHR, text, error) {
				$("#loaderID").hide();
				alert(jqXHR.status + text + error);
				console.log(productbatchcomp);

			}

		});

		console.log("Not skipped!");

		UpdateToSubmitedProductBatchComp(productBatchID, commodityID, number);

	}
	else {
		$("#loaderID").hide();
		alert("Netto vægt ikke inden for tolerancen");
		console.log("Netto weight: not accepted");
	}


}



function updateProductBatchToFinish() {
	console.log("Jeg er i gang med at slukke for lortet");
	$("#loaderID").show();

	var today = new Date();

	var productBatch = {
		prescription_id: weightPriscriptiuonID, // $("#showPrescriptionID").val(),
		productBatch_id: $("#ProductBatchToWeight").val(),
		status: 3,
		//		startDate: 1,
		//		endDate: 1
	};

	$.ajax({
		url: "https://api.mama.sh/ProductBatchs",
		contentType: "application/json",
		method: "PUT",
		data: JSON.stringify(productBatch),
		success: function (response) {
			$("#loaderID").hide();
			// getProductBatch(productBatch.productBatch_id, false);
			//$("#WeightProductBatchStartDate").html($("#showStartDate").html());
			//$("#WeightProductBatchEndDate").html( $("#showEndDate").html());
		},
		error: function (data, text, error) {
			$("#loaderID").hide();
			console.log("fejl: Produkt Batch ikke opdateres");
		}

	});
}

async function UpdateToSubmitedProductBatchComp(productBatchID, commodityID, number) {
	$("#loaderID").show();
	console.log("starting update");

	await $.ajax({
		url: "https://api.mama.sh/productbatchcomp/component?productBatchId=" + productBatchID + "&commodityBatchId=" + commodityID,
		contentType: "application/json",
		type: "GET",
		success: function (response) {
			$("#loaderID").hide();

			//const promise1 = new Promise((resolve, reject) => {
			$("#WeightLineTara" + number).html(response.tara);
			$("#WeightLineNetto" + number).html(response.netto);
			$("#WeightLineBatch" + number).html(response.commodityBatch_id);
			$("#WeightLineOpr" + number).html(response.user_id);
			$("#WeightLineTerminal" + number).html(1);
			// });


			//	promise1.then((value) => {


			// show and hide button stuff
			console.log("started to show BTN");
			$('#WeightSubmitBtn' + number).hide();
			console.log("End og BTN")
			// end of document ready

			// test for last button
			try {
				document.getElementById("WeightSubmitBtn" + (number + 1)).style.display = "block";
			}
			catch { // end of commodity to productbatch
				console.log("done!");

				while ($('#WeightLineTara' + number).html() != Number(response.tara)) {
					// test stuff
					// end of while loop
					console.log("while loop");
				}
			}

			// get all netto and tara weight
			sumTotal(number);

			// update status to "Afsluttet" and update end date
			updateProductBatchToFinish();
			$("#loaderID").hide();
			//}

			//	}); 
		},
		error: function (jqXHR, text, error) {
			$("#loaderID").hide();
			//  alert(jqXHR.status + text + error);
			console.log("Doenst exit in database");
		}




		// end of document ready
	});
}

async function ShowPrescriptionCompToLab(PrescriptionComp, number, productBatchID) {
	var commoditybatchList = document.getElementById("WeightCommodityBatchList");


	getCommodity(PrescriptionComp.commodity_id);


	console.log("Dette er det nummer råvare vi laver" + number);
	var commodityName = $("#showRåvareNavn").val();

	commoditybatchList.innerHTML += '<div > '
		+ ' <h5>Råvare nr: <label id="WeightCommodityID">' + PrescriptionComp.commodity_id + '</label></h5> '
		+ '<h5>Råvare Navn: ' + commodityName + '</h5> '
		+ ' <table id="ListOfProductBatchTable" class="w3-table w3-striped w3-bordered w3-border w3-hoverable w3-white"> '
		+ ' <tr> '
		+ '<td>Del</td> '
		+ '<td>Mængde</td>'
		+ '<td>Tolerance</td>'
		+ '<td>Tara</td>'
		+ '<td>Netto (kg)</td>'
		+ '<td>Batch</td>'
		+ '<td>Opr</td>'
		+ '<td>Terminal</td>'
		+ '</tr>'
		+ '<tr >'
		+ '<td>1</td>'
		+ '<td id="WeightLineNonNetto' + number + '">' + PrescriptionComp.nomNetto + '</td>'
		+ '<td id="WeightLineTolerance' + number + '">' + PrescriptionComp.tolerance + '</td>'
		+ '<td id="WeightLineTara' + number + '"><input type="text" id="WeightTara' + PrescriptionComp.commodity_id + '"></input></td>'
		+ '<td id="WeightLineNetto' + number + '"><input type="text" id="WeightNetto' + PrescriptionComp.commodity_id + '"></input></td>'
		+ '<td id="WeightLineBatch' + number + '"><input type="text"></input></td>'
		+ '<td id="WeightLineOpr' + number + '">' + userobject.userID + '</input></td>'
		+ '<td id="WeightLineTerminal' + number + '">1</td>'
		+ '</tr>'
		+ '</table>'
		+ '<br>'
		+ '<button id="WeightSubmitBtn' + number + '" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 border border-blue-700 rounded" onclick="CreateProductBatchComp(' + PrescriptionComp.commodity_id + ',' + number + ');"> submit Råvare: ' + PrescriptionComp.commodity_id + '</button>'
		+ '</div> <br/>';


	//$(document).ready( function () {toggleModal();});
	UpdateToSubmitedProductBatchComp(productBatchID, PrescriptionComp.commodity_id, number);
}

{"commodity_id":1,"nomNetto":8.2,"prescription_id":1,"tolerance":9.7},{"commodity_id":2,"nomNetto":15.5,"prescription_id":1,"tolerance":0.4},{"commodity_id":1,"nomNetto":1.0,"prescription_id":10,"tolerance":1.0},{"commodity_id":2,"nomNetto":8.0,"prescription_id":10,"tolerance":0.4},{"commodity_id":4,"nomNetto":5.5,"prescription_id":10,"tolerance":0.5},{"commodity_id":5,"nomNetto":11.1,"prescription_id":10,"tolerance":0.3}]